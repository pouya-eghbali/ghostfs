services:
  ghostfs-csi:
    build:
      context: ..
      dockerfile: e2e/Dockerfile.csi
    platform: linux/amd64
    privileged: true
    cap_add:
      - SYS_ADMIN
    devices:
      - /dev/fuse
    security_opt:
      - apparmor:unconfined
    volumes:
      - ./tests:/tests:ro
    environment:
      - GHOSTFS_ROOT=/data/root
      - GHOSTFS_MOUNT=/mnt/ghostfs
      - GHOSTFS_HOST=127.0.0.1
      - GHOSTFS_PORT=3444
      - GHOSTFS_AUTH_PORT=3445
      - CSI_SOCKET=/csi/csi.sock
    command: ["/tests/run-csi-e2e.sh"]
